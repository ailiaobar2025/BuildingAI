# AI 图片生成功能文档

> 基于火山引擎即梦 4.0 的智能图片生成功能

## 📖 目录

- [快速开始](#快速开始)
- [功能特性](#功能特性)
- [使用指南](#使用指南)
- [配置说明](#配置说明)
- [UI设计说明](#ui设计说明)
- [API接口](#api接口)
- [常见问题](#常见问题)

---

## 快速开始

### 访问方式

**控制台访问**（推荐）：
```
http://localhost:4090/console/image-generation
```

### 第一次使用

1. **输入提示词**：
   ```
   一只可爱的橘色小猫坐在窗台上晒太阳，温馨的室内场景
   ```

2. **点击"开始生成图片"按钮**

3. **等待 10-30 秒**

4. **查看并下载生成的图片**

---

## 功能特性

### 核心能力

| 功能 | 说明 | 支持情况 |
|------|------|---------|
| 🎨 **文生图** | 根据文本描述生成图片 | ✅ |
| 🖼️ **图生图** | 基于参考图片生成新图片 | ✅ |
| 📦 **多图组合** | 最多10张参考图智能组合 | ✅ |
| 🎯 **智能编辑** | 增删改替，深度理解意图 | ✅ |
| 🔍 **4K超高清** | 最高支持 4096x4096 分辨率 | ✅ |
| 📊 **组图生成** | 一次生成 1-15 张图片 | ✅ |
| 📏 **智能比例** | 6种预设比例 + 自定义尺寸 | ✅ |
| 🎚️ **参考强度** | 控制参考图影响程度（0-1） | ✅ |

### 技术特性

- **实时进度条**：直观显示生成进度（0-95%）
- **状态追踪**：排队中 → 生成中 → 完成
- **错误处理**：友好的错误提示和重试机制
- **响应式设计**：支持桌面、平板、移动设备
- **深色模式**：完整的深色主题支持

---

## 使用指南

### 1. 文生图（Text to Image）

根据文本描述生成图片：

**步骤**：
1. 在"描述提示词"输入框中输入描述
2. （可选）展开高级选项，选择比例和尺寸
3. 点击"开始生成图片"按钮
4. 等待生成完成
5. 下载图片或复制链接

**示例**：
```
提示词：科幻风格的未来城市，霓虹灯，赛博朋克，夜景，高清
比例：16:9
尺寸：1920x1080
```

### 2. 图生图（Image to Image）

基于参考图片生成新图片：

**步骤**：
1. 点击"添加参考图片"按钮
2. 输入参考图片的 URL（最多10张）
3. 输入文本描述
4. 设置参考强度（0-1）
5. 点击生成

**示例**：
```
参考图：https://example.com/reference.jpg
提示词：改成卡通风格，增加更多细节
参考强度：0.7
```

### 3. 组图生成

一次生成多张相关图片：

**步骤**：
1. 在提示词中使用组图关键词
2. 展开高级选项，设置生成数量
3. 点击生成

**示例**：
```
提示词：生成4张海报，标题为"即梦4.0"，分别为春夏秋冬主题
生成数量：4
```

### 4. 高级选项说明

#### 图片比例
- **1:1** (1024x1024) - 正方形，适合头像、Logo
- **16:9** (1920x1080) - 横向宽屏，适合封面、Banner
- **9:16** (1080x1920) - 竖向，适合手机壁纸
- **4:3** (1600x1200) - 标准横向
- **3:4** (1200x1600) - 标准竖向
- **21:9** (2560x1080) - 超宽屏

#### 生成数量
- 范围：1-15 张
- 使用"一系列"、"组图"等提示词可智能调整

#### 参考强度
- 范围：0-1
- 0：弱参考，更多创意发挥
- 0.5：适中，平衡参考与创意
- 1：强参考，更接近参考图

---

## 配置说明

### 环境变量

在 `.env.development.local` 或 `.env.production.local` 中配置：

```bash
# 火山引擎图片生成配置
VOLCENGINE_IMAGE_ENDPOINT=https://visual.volcengineapi.com
VOLCENGINE_IMAGE_REGION=cn-north-1
VOLCENGINE_IMAGE_SERVICE=cv
VOLCENGINE_IMAGE_ACCESS_KEY_ID=your_access_key_id
VOLCENGINE_IMAGE_SECRET_ACCESS_KEY=your_secret_access_key
VOLCENGINE_IMAGE_DEFAULT_REQ_KEY=jimeng_t2i_v40
```

### 获取密钥

1. 访问 [火山引擎控制台](https://console.volcengine.com/)
2. 开通即梦 AI 服务
3. 创建 Access Key
4. 将密钥配置到环境变量中

---

## UI设计说明

### 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  即梦 AI 图片生成 4.0                    [使用指南]      │
├──────────────────┬──────────────────────────────────────┤
│                  │                                      │
│   生成设置       │         生成结果                     │
│                  │                                      │
│  - 提示词输入    │   [等待状态 / 生成中 / 结果展示]    │
│  - 参考图片      │                                      │
│  - 高级选项      │   - 进度条                           │
│    • 比例        │   - 图片网格                         │
│    • 数量        │   - 操作按钮                         │
│    • 强度        │                                      │
│                  │                                      │
│  [开始生成图片]  │                                      │
│                  │                                      │
└──────────────────┴──────────────────────────────────────┘
```

### 视觉特性

- **渐变色主题**：紫色(#9333EA) → 粉色(#DB2777)
- **图标系统**：Lucide Icons
- **动画效果**：淡入淡出、脉冲、旋转、波纹
- **响应式布局**：XL屏幕 1:2，其他全宽

### 交互状态

#### 等待状态
- 大型 sparkles 图标
- 4个功能特性卡片
- 开始创作之旅提示

#### 生成中状态
- 双层 sparkles 动画
- 渐变进度条（0-95%）
- 任务 ID 显示
- 预计时间提示

#### 完成状态
- 响应式网格布局（1/2/3列）
- 悬浮操作按钮
- 图片序号显示
- 成功提示卡片

---

## API接口

### 1. 提交图片生成任务

**接口**：`POST /api/image-generation/submit`

**请求参数**：
```typescript
{
  prompt: string;           // 提示词（必填，1-800字符）
  imageUrls?: string[];     // 参考图片URL（可选，最多10张）
  width?: number;           // 宽度（可选，512-4096）
  height?: number;          // 高度（可选，512-4096）
  scale?: number;           // 参考强度（可选，0-1）
  size?: number;            // 图片面积（可选）
  forceSingle?: boolean;    // 强制单张输出（可选）
  minRatio?: number;        // 最小宽高比（可选，1/16-16）
  maxRatio?: number;        // 最大宽高比（可选，1/16-16）
}
```

**响应**：
```typescript
{
  taskId: string;           // 任务ID
  raw?: any;                // 原始响应
}
```

### 2. 查询生成结果

**接口**：`POST /api/image-generation/query`

**请求参数**：
```typescript
{
  taskId: string;           // 任务ID（必填）
  returnUrl?: boolean;      // 是否返回URL（可选）
  addLogo?: boolean;        // 是否添加水印（可选）
  // ... 其他水印和认证参数
}
```

**响应**：
```typescript
{
  status: 'in_queue' | 'generating' | 'done' | 'not_found' | 'expired';
  imageUrls?: string[];     // 图片URL列表
  base64List?: string[];    // Base64数据列表
  raw?: any;                // 原始响应
}
```

---

## 常见问题

### Q: 生成速度慢怎么办？

**A**: 图片生成通常需要 10-30 秒：
- ✅ 正常：10-30秒
- ⚠️ 较慢：30-60秒（队列繁忙）
- ❌ 超时：>60秒（建议重试）

**解决方案**：
1. 耐心等待，查看进度条
2. 如果超时，点击重新生成
3. 避免高峰时段使用

### Q: 生成失败怎么办？

**常见错误及解决方案**：

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| 40602 | 签名验证失败 | 已修复，重启服务器 |
| 401 | 未登录 | 重新登录系统 |
| 审核未通过 | 提示词违规 | 修改提示词内容 |
| 频率限制 | 调用过快 | 等待后重试 |

### Q: 如何提高生成质量？

**最佳实践**：

1. **详细描述**
   - ✅ 好：一只橘色小猫坐在木质窗台上，阳光透过窗户洒在它身上，温馨的室内场景
   - ❌ 差：猫

2. **指定风格**
   - 油画风格、水彩画、赛博朋克、卡通风格等

3. **描述细节**
   - 光线、色调、构图、环境等

4. **使用高分辨率**
   - 1024x1024 或更高
   - 4K：2048x2048 以上

5. **重要文字用引号**
   - 例如：标题为"即梦4.0"

### Q: 参考图无法加载？

**检查清单**：
- ✅ URL 是否正确
- ✅ 图片是否公开访问
- ✅ 图片格式是否支持（JPG/PNG）
- ✅ 图片大小是否合理

### Q: 如何使用组图功能？

**提示词技巧**：
- 使用"一系列"、"组图"、"生成X张图"等关键词
- 例如：生成4张海报，分别为春夏秋冬主题
- 例如：参考图片形象生成一组日漫分镜

**设置方法**：
1. 展开高级选项
2. 设置生成数量（1-15）
3. 在提示词中说明组图需求

### Q: 生成的图片如何保存？

**两种方式**：

1. **下载图片**
   - 鼠标悬停在图片上
   - 点击"下载"按钮
   - 保存到本地

2. **复制链接**
   - 鼠标悬停在图片上
   - 点击"复制链接"按钮
   - 在其他地方粘贴使用

⚠️ **注意**：图片链接可能有有效期，建议及时下载保存。

### Q: 有使用限制吗？

**限制说明**：
- 调用频率限制（防止滥用）
- API 配额限制（根据账户）
- 内容审核限制（违规内容拒绝）

**建议**：
- 合理控制调用频率
- 注意成本控制
- 遵守内容规范

---

## 技术架构

### 前端技术栈
- **框架**：Vue 3 + Nuxt 3
- **UI组件**：Nuxt UI
- **图标**：Lucide Icons
- **样式**：Tailwind CSS
- **动画**：CSS Transitions & Animations

### 后端技术栈
- **框架**：NestJS
- **API集成**：火山引擎即梦 4.0
- **签名算法**：AWS Signature V4
- **参数验证**：class-validator

### 文件结构
```
apps/
├── server/src/
│   ├── modules/web/ai/
│   │   ├── controllers/
│   │   │   └── image-generation.controller.ts
│   │   ├── services/
│   │   │   └── image-generation.service.ts
│   │   └── dto/
│   │       └── image-generation.dto.ts
│   └── sdk/ai/volcengine/
│       └── image-generation.sdk.ts
└── web/
    ├── app/console/image-generation/
    │   └── index.vue
    └── services/web/
        └── image-generation.ts
```

---

## 更新日志

### v1.0.0 (2025-10-21)

#### 新增功能
- ✅ 文生图功能
- ✅ 图生图功能（最多10张参考图）
- ✅ 组图生成（1-15张）
- ✅ 高级选项（比例/数量/强度）
- ✅ 实时进度条
- ✅ 响应式UI设计
- ✅ 深色模式支持

#### 优化改进
- ✅ 修复签名算法问题
- ✅ 优化UI布局和交互
- ✅ 增加详细说明和提示
- ✅ 改进错误处理

#### 已知问题
- 暂无

---

## 参考资料

- [火山引擎即梦 4.0 产品介绍](https://www.volcengine.com/docs/85621/1820192)
- [火山引擎即梦 4.0 接口文档](https://www.volcengine.com/docs/85621/1817045)
- [OpenSpec 规格文档](../openspec/specs/ai-image-generation/spec.md)

---

## 支持

如有问题，请查看：
- [OpenSpec 变更记录](../openspec/changes/archive/)
- [后端实现文档](../apps/server/src/modules/web/ai/README_IMAGE_GENERATION.md)
- 或联系技术支持团队

---

**最后更新**：2025-10-21  
**版本**：v1.0.0  
**维护者**：BuildingAI Team
